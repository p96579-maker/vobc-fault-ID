<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VOBC FAULT ID SEARCH</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <style>
    :root { --bg:#0b1220; --panel:#121a2b; --muted:#a6b0cf; --pri:#7c5cff; --card:#0f1524; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:white;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;line-height:1.4}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 16px}
    .searchbar{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;background:var(--panel);padding:12px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .searchbar label{font-size:13.2px;color:var(--muted)}
    .searchbar label.emph{font-size:110%}
    .searchbar input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #263252;background:#0c1221;color:#e8ecff;outline:none}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #2a3660;background:var(--pri);color:white;cursor:pointer;font-weight:600}
    .toolbar{display:flex;gap:8px;align-items:center}
    .note{color:var(--muted);font-size:12px}
    .results{margin-top:16px;display:flex;flex-direction:column;gap:12px}
    .card{background:var(--card);border:1px solid #223052;border-radius:14px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.28);width:100%}
    .kvs{display:grid;grid-template-columns:160px 1fr;gap:6px 14px;margin-top:10px;line-height:1.5}
    .kvs .k{color:#cfe1ff;opacity:.95;font-weight:600;letter-spacing:.2px}
    .pill{display:inline-block;border:1px solid #32406d;border-radius:999px;padding:2px 8px;font-size:12px;color:#cfe1ff;background:#11182b}
    .pill.apf{font-size:120%; padding:4px 10px; font-weight:700}
    .hidden{display:none !important}
    .footer{margin-top:18px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    a.dl{color:#cfe1ff}
    .toast{position:fixed;right:18px;bottom:18px;background:#0d1426;color:#e8ecff;border:1px solid #233153;padding:12px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.4);z-index:9999;max-width:420px}
    .toast.hidden{display:none}
    .toast h4{margin:0 0 6px;font-size:14px;color:#cfe1ff}
    .toast .meta{font-size:13px;color:#a6b0cf}
    .kvs > div:nth-child(2n){border-bottom:1px dashed #2a3761;padding-bottom:6px;margin-bottom:6px}
    .kvs > div:nth-last-child(-n+2){border-bottom:none;margin-bottom:0;padding-bottom:0}
    .status{font-size:12px;color:#a6b0cf}
  </style>
</head>
<body>
<div class="wrap">
  <h1>VOBC FAULT ID SEARCH</h1>

  <div class="searchbar">
    <div>
      <label>ApplFault</label>
      <input id="qAp" placeholder="e.g. 2852">
    </div>
    <div>
      <label>errorCode</label>
      <input id="qErr" placeholder="e.g. 0x835 or 835">
    </div>
    <div>
      <label>Msg ID</label>
      <input id="qMsg" placeholder="e.g. MSG-1234">
    </div>
    <div class="toolbar">
      <button id="btn" class="btn">Search</button>
      <button id="clear" class="btn" style="background:#32406d;border-color:#32406d">CLEAR</button>
      <button id="update" class="btn" title="Check & update to latest">UPDATE</button>
      <span id="count" class="pill hidden"></span>
    </div>
  </div>

  <div id="results" class="results hidden"></div>

  <div class="footer">
    <span class="note">Data: <code>assets/dedup.json</code>. Offline-ready; UPDATE pulls newest data + app shell.</span>
    <span class="status" id="status"></span>
    <a class="dl" href="./assets/atp_var_enums_dedup.xlsx" download>Download Excel</a>
  </div>
</div>

<script>
// PWA: register SW
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
  // when new SW takes control, reload
  navigator.serviceWorker.addEventListener('controllerchange', ()=>location.reload());
}

const $ = (s)=>document.querySelector(s);
const results = $("#results");
const badge = $("#count");
const btn = $("#btn");
const statusEl = $("#status");
const updateBtn = $("#update");

const normAppl = (s)=>{ const m = String(s||'').match(/-?\d+(?:\.\d+)?/); if(!m) return ''; const f = parseFloat(m[0]); if (Number.isNaN(f)) return ''; return String(Math.trunc(f)); };
const normHex = (s)=> (s||'').toString().trim().replace(/^0x/i,'').toLowerCase();

const BASE = (function() {
  const p = location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^/]+$/, '');
  return p.endsWith('/') ? p : p + '/';
})();

let DATA = [];
btn.disabled = true;
btn.textContent = "Loading...";

// Load data (cache-first fallback is handled by SW; here we prefer network on UPDATE)
async function loadData(networkOnly=false){
  try{
    statusEl.textContent = networkOnly ? "Updating data…" : "";
    const url = BASE + 'assets/dedup.json' + (networkOnly ? ('?v=' + Date.now()) : '');
    const opts = networkOnly ? {cache:'no-store'} : {};
    const r = await fetch(url, opts);
    DATA = await r.json();
    btn.disabled = false; btn.textContent = "Search";
    statusEl.textContent = networkOnly ? "Data refreshed" : "";
  }catch(e){
    console.error(e);
    btn.disabled = false; btn.textContent = "Search";
    statusEl.textContent = networkOnly ? "Update failed (offline?)" : "Offline data";
  }
}
loadData(false);

// UI render

function matchRow(row, qA, qEhex, qEdec, qM){
  // normalize row values
  const rawEC = String(row.errorCode||'').trim();
  const rowIsHex = /^0x/i.test(rawEC) || /^[0-9a-f]+$/i.test(rawEC) && /[a-f]/i.test(rawEC); // heuristic
  // parse row decimal no matter stored as hex or dec
  let rowDec = NaN;
  try{
    rowDec = rowIsHex ? parseInt(rawEC.replace(/^0x/i,''), 16) : parseInt(rawEC, 10);
  }catch{}
  const rowHex = Number.isFinite(rowDec) ? rowDec.toString(16) : rawEC.replace(/^0x/i,'').toLowerCase();

  if (qA && !String(row.applFault||'').startsWith(qA)) return false;

  // errorCode filter: accept match if any of these hold
  if (qEhex || qEdec!=null){
    let ok = true;
    if (qEhex){
      const qDecFromHex = parseInt(qEhex, 16);
      ok = ok && (rowHex === qEhex.toLowerCase() || (Number.isFinite(rowDec) && rowDec === qDecFromHex));
    }
    if (qEdec!=null){
      // also compare qEdec to rowDec
      ok = ok && (Number.isFinite(rowDec) && rowDec === qEdec);
    }
    if (!ok) return false;
  }

  if (qM && !String(row.msgId||'').toLowerCase().includes(qM)) return false;
  return true;
}

function render(rows){
  results.innerHTML = '';
  if (!rows.length) {
    results.classList.add('hidden');
    badge.classList.add('hidden');
    return;
  }
  results.classList.remove('hidden');
  badge.textContent = rows.length + ' result' + (rows.length>1?'s':''); badge.classList.remove('hidden');
  const escapeHtml = (s)=> String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  for (const r of rows){
    const card = document.createElement('div'); card.className = 'card';
    const rowsKV = [];
    const isBlank = (s)=> !String(s||'').trim();
    const addRowHTML = (k, h) => { if (!isBlank(h)) rowsKV.push(`<div class="k">${k}</div><div>${h}</div>`); };
    const addRowText = (k, v) => { const t = String(v||'').trim(); if (!t || t.toLowerCase()==='nan') return; rowsKV.push(`<div class="k">${k}</div><div>${escapeHtml(t)}</div>`); };

    addRowText('errorCode', r.errorCode ? '0x' + String(r.errorCode).toUpperCase() : '');
    let msg = String(r.msgId||'').trim(); if (/^-?\d+\.0+$/.test(msg)) msg = String(parseInt(msg,10));
    addRowText('Msg ID', msg);
    addRowText('Symptom', r.symptom);
    addRowText('Description', r.description);
    addRowText('Replace', r.replace);
    addRowText('Refer To', r.referTo);
    addRowText('Note', r.note);

    card.innerHTML = \`
      <div class="pill apf">ApplFault: <b>\${escapeHtml(r.applFault||'')}</b></div>
      <div class="kvs">\${rowsKV.join('')}</div>\`;
    results.appendChild(card);
  }
}

function doSearch(){
  const qA = normAppl(document.querySelector("#qAp").value);
  const rawErr = (document.querySelector("#qErr").value||'').trim();
  const qEhex = normHex(rawErr) || '';
  const qEdec = (/^[0-9]+$/.test(rawErr) ? parseInt(rawErr,10) : null);
  const qM = (document.querySelector("#qMsg").value||'').trim().toLowerCase();
  const rows = DATA.filter(r => matchRow(r, qA, qEhex, qEdec, qM));
  render(rows);
}
btn.addEventListener('click', ()=>{ if (!btn.disabled) doSearch(); });
document.querySelector('#clear').addEventListener('click', ()=>{
  ['#qAp','#qErr','#qMsg'].forEach(sel=>document.querySelector(sel).value='');
  results.innerHTML=''; results.classList.add('hidden'); badge.textContent=''; badge.classList.add('hidden');
});
['qAp','qErr','qMsg'].forEach(id=>{ document.getElementById(id).addEventListener('keydown', e=>{ if(e.key==='Enter' && !btn.disabled) doSearch(); }); });

// UPDATE button: refresh data and app shell
async function updateNow(){
  statusEl.textContent = "Checking update…";
  await loadData(true);
  if('serviceWorker' in navigator){
    const reg = await navigator.serviceWorker.getRegistration();
    try{ await reg?.update(); }catch(e){}
    if(reg && reg.waiting){
      // Ask waiting SW to skip waiting then reload via controllerchange
      reg.waiting.postMessage({type:'SKIP_WAITING'});
      statusEl.textContent = "Switching to new version…";
    }else{
      // Warmup current SW to revalidate shell
      reg?.active?.postMessage({type:'WARMUP'});
      statusEl.textContent = "Data updated (shell is up-to-date)";
    }
  }else{
    statusEl.textContent = "Data updated";
  }
}
updateBtn.addEventListener('click', updateNow);
</script>
</body>
</html>